(KEYWORD import)
(ID "os")
(NEWLINE)
(KEYWORD import)
(ID "signal")
(NEWLINE)
(KEYWORD import)
(ID "sys")
(NEWLINE)
(KEYWORD import)
(ID "threading")
(NEWLINE)
(KEYWORD import)
(ID "warnings")
(NEWLINE)
(KEYWORD import)
(ID "_multiprocessing")
(NEWLINE)
(KEYWORD from)
(PUNCT ".")
(KEYWORD import)
(ID "spawn")
(NEWLINE)
(KEYWORD from)
(PUNCT ".")
(KEYWORD import)
(ID "util")
(NEWLINE)
(ID "__all__")
(PUNCT "=")
(PUNCT "[")
(LIT "ensure_running")
(PUNCT ",")
(LIT "register")
(PUNCT ",")
(LIT "unregister")
(PUNCT "]")
(NEWLINE)
(KEYWORD class)
(ID "SemaphoreTracker")
(PUNCT "(")
(ID "object")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD def)
(ID "__init__")
(PUNCT "(")
(ID "self")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "self")
(PUNCT ".")
(ID "_lock")
(PUNCT "=")
(ID "threading")
(PUNCT ".")
(ID "Lock")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_fd")
(PUNCT "=")
(KEYWORD None)
(NEWLINE)
(DEDENT)
(KEYWORD def)
(ID "getfd")
(PUNCT "(")
(ID "self")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "self")
(PUNCT ".")
(ID "ensure_running")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(KEYWORD return)
(ID "self")
(PUNCT ".")
(ID "_fd")
(NEWLINE)
(DEDENT)
(KEYWORD def)
(ID "ensure_running")
(PUNCT "(")
(ID "self")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(LIT "Make sure that semaphore tracker process is running.\n\n        This can be run from any process.  Usually a child process will use\n        the semaphore created by its parent.")
(NEWLINE)
(KEYWORD with)
(ID "self")
(PUNCT ".")
(ID "_lock")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD if)
(ID "self")
(PUNCT ".")
(ID "_fd")
(KEYWORD is)
(KEYWORD not)
(KEYWORD None)
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD return)
(NEWLINE)
(DEDENT)
(ID "fds_to_pass")
(PUNCT "=")
(PUNCT "[")
(PUNCT "]")
(NEWLINE)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "fds_to_pass")
(PUNCT ".")
(ID "append")
(PUNCT "(")
(ID "sys")
(PUNCT ".")
(ID "stderr")
(PUNCT ".")
(ID "fileno")
(PUNCT "(")
(PUNCT ")")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD except)
(ID "Exception")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD pass)
(NEWLINE)
(DEDENT)
(ID "cmd")
(PUNCT "=")
(LIT "from multiprocessing.semaphore_tracker import main;main(%d)")
(NEWLINE)
(ID "r")
(PUNCT ",")
(ID "w")
(PUNCT "=")
(ID "os")
(PUNCT ".")
(ID "pipe")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "fds_to_pass")
(PUNCT ".")
(ID "append")
(PUNCT "(")
(ID "r")
(PUNCT ")")
(NEWLINE)
(ID "exe")
(PUNCT "=")
(ID "spawn")
(PUNCT ".")
(ID "get_executable")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "args")
(PUNCT "=")
(PUNCT "[")
(ID "exe")
(PUNCT "]")
(PUNCT "+")
(ID "util")
(PUNCT ".")
(ID "_args_from_interpreter_flags")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "args")
(PUNCT "+=")
(PUNCT "[")
(LIT "-c")
(PUNCT ",")
(ID "cmd")
(PUNCT "%")
(ID "r")
(PUNCT "]")
(NEWLINE)
(ID "util")
(PUNCT ".")
(ID "spawnv_passfds")
(PUNCT "(")
(ID "exe")
(PUNCT ",")
(ID "args")
(PUNCT ",")
(ID "fds_to_pass")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD except)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "os")
(PUNCT ".")
(ID "close")
(PUNCT "(")
(ID "w")
(PUNCT ")")
(NEWLINE)
(KEYWORD raise)
(NEWLINE)
(DEDENT)
(KEYWORD else)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "self")
(PUNCT ".")
(ID "_fd")
(PUNCT "=")
(ID "w")
(NEWLINE)
(DEDENT)
(KEYWORD finally)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "os")
(PUNCT ".")
(ID "close")
(PUNCT "(")
(ID "r")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(DEDENT)
(DEDENT)
(KEYWORD def)
(ID "register")
(PUNCT "(")
(ID "self")
(PUNCT ",")
(ID "name")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(LIT "Register name of semaphore with semaphore tracker.")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_send")
(PUNCT "(")
(LIT "REGISTER")
(PUNCT ",")
(ID "name")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD def)
(ID "unregister")
(PUNCT "(")
(ID "self")
(PUNCT ",")
(ID "name")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(LIT "Unregister name of semaphore with semaphore tracker.")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_send")
(PUNCT "(")
(LIT "UNREGISTER")
(PUNCT ",")
(ID "name")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD def)
(ID "_send")
(PUNCT "(")
(ID "self")
(PUNCT ",")
(ID "cmd")
(PUNCT ",")
(ID "name")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "self")
(PUNCT ".")
(ID "ensure_running")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "msg")
(PUNCT "=")
(LIT "{0}:{1}\n")
(PUNCT ".")
(ID "format")
(PUNCT "(")
(ID "cmd")
(PUNCT ",")
(ID "name")
(PUNCT ")")
(PUNCT ".")
(ID "encode")
(PUNCT "(")
(LIT "ascii")
(PUNCT ")")
(NEWLINE)
(KEYWORD if)
(ID "len")
(PUNCT "(")
(ID "name")
(PUNCT ")")
(PUNCT ">")
(LIT 512)
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD raise)
(ID "ValueError")
(PUNCT "(")
(LIT "name too long")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(ID "nbytes")
(PUNCT "=")
(ID "os")
(PUNCT ".")
(ID "write")
(PUNCT "(")
(ID "self")
(PUNCT ".")
(ID "_fd")
(PUNCT ",")
(ID "msg")
(PUNCT ")")
(NEWLINE)
(KEYWORD assert)
(ID "nbytes")
(PUNCT "==")
(ID "len")
(PUNCT "(")
(ID "msg")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(DEDENT)
(ID "_semaphore_tracker")
(PUNCT "=")
(ID "SemaphoreTracker")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "ensure_running")
(PUNCT "=")
(ID "_semaphore_tracker")
(PUNCT ".")
(ID "ensure_running")
(NEWLINE)
(ID "register")
(PUNCT "=")
(ID "_semaphore_tracker")
(PUNCT ".")
(ID "register")
(NEWLINE)
(ID "unregister")
(PUNCT "=")
(ID "_semaphore_tracker")
(PUNCT ".")
(ID "unregister")
(NEWLINE)
(ID "getfd")
(PUNCT "=")
(ID "_semaphore_tracker")
(PUNCT ".")
(ID "getfd")
(NEWLINE)
(KEYWORD def)
(ID "main")
(PUNCT "(")
(ID "fd")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(LIT "Run semaphore tracker.")
(NEWLINE)
(ID "signal")
(PUNCT ".")
(ID "signal")
(PUNCT "(")
(ID "signal")
(PUNCT ".")
(ID "SIGINT")
(PUNCT ",")
(ID "signal")
(PUNCT ".")
(ID "SIG_IGN")
(PUNCT ")")
(NEWLINE)
(ID "signal")
(PUNCT ".")
(ID "signal")
(PUNCT "(")
(ID "signal")
(PUNCT ".")
(ID "SIGTERM")
(PUNCT ",")
(ID "signal")
(PUNCT ".")
(ID "SIG_IGN")
(PUNCT ")")
(NEWLINE)
(KEYWORD for)
(ID "f")
(KEYWORD in)
(PUNCT "(")
(ID "sys")
(PUNCT ".")
(ID "stdin")
(PUNCT ",")
(ID "sys")
(PUNCT ".")
(ID "stdout")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "f")
(PUNCT ".")
(ID "close")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD except)
(ID "Exception")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD pass)
(NEWLINE)
(DEDENT)
(DEDENT)
(ID "cache")
(PUNCT "=")
(ID "set")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD with)
(ID "open")
(PUNCT "(")
(ID "fd")
(PUNCT ",")
(LIT "rb")
(PUNCT ")")
(KEYWORD as)
(ID "f")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD for)
(ID "line")
(KEYWORD in)
(ID "f")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "cmd")
(PUNCT ",")
(ID "name")
(PUNCT "=")
(ID "line")
(PUNCT ".")
(ID "strip")
(PUNCT "(")
(PUNCT ")")
(PUNCT ".")
(ID "split")
(PUNCT "(")
(LIT #":")
(PUNCT ")")
(NEWLINE)
(KEYWORD if)
(ID "cmd")
(PUNCT "==")
(LIT #"REGISTER")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "cache")
(PUNCT ".")
(ID "add")
(PUNCT "(")
(ID "name")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD elif)
(ID "cmd")
(PUNCT "==")
(LIT #"UNREGISTER")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "cache")
(PUNCT ".")
(ID "remove")
(PUNCT "(")
(ID "name")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD else)
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD raise)
(ID "RuntimeError")
(PUNCT "(")
(LIT "unrecognized command %r")
(PUNCT "%")
(ID "cmd")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(DEDENT)
(KEYWORD except)
(ID "Exception")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "sys")
(PUNCT ".")
(ID "excepthook")
(PUNCT "(")
(PUNCT "*")
(ID "sys")
(PUNCT ".")
(ID "exc_info")
(PUNCT "(")
(PUNCT ")")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD except)
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD pass)
(NEWLINE)
(DEDENT)
(DEDENT)
(DEDENT)
(DEDENT)
(DEDENT)
(KEYWORD finally)
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD if)
(ID "cache")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "warnings")
(PUNCT ".")
(ID "warn")
(PUNCT "(")
(LIT "semaphore_tracker: There appear to be %d ")
(LIT "leaked semaphores to clean up at shutdown")
(PUNCT "%")
(ID "len")
(PUNCT "(")
(ID "cache")
(PUNCT ")")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD except)
(ID "Exception")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD pass)
(NEWLINE)
(DEDENT)
(DEDENT)
(KEYWORD for)
(ID "name")
(KEYWORD in)
(ID "cache")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "name")
(PUNCT "=")
(ID "name")
(PUNCT ".")
(ID "decode")
(PUNCT "(")
(LIT "ascii")
(PUNCT ")")
(NEWLINE)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "_multiprocessing")
(PUNCT ".")
(ID "sem_unlink")
(PUNCT "(")
(ID "name")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD except)
(ID "Exception")
(KEYWORD as)
(ID "e")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "warnings")
(PUNCT ".")
(ID "warn")
(PUNCT "(")
(LIT "semaphore_tracker: %r: %s")
(PUNCT "%")
(PUNCT "(")
(ID "name")
(PUNCT ",")
(ID "e")
(PUNCT ")")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(DEDENT)
(KEYWORD finally)
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD pass)
(NEWLINE)
(DEDENT)
(DEDENT)
(DEDENT)
(DEDENT)
(ENDMARKER)
