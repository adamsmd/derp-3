(LIT "Implements ThreadPoolExecutor.")
(NEWLINE)
(ID "__author__")
(PUNCT "=")
(LIT "Brian Quinlan (brian@sweetapp.com)")
(NEWLINE)
(KEYWORD import)
(ID "atexit")
(NEWLINE)
(KEYWORD from)
(ID "concurrent")
(PUNCT ".")
(ID "futures")
(KEYWORD import)
(ID "_base")
(NEWLINE)
(KEYWORD import)
(ID "queue")
(NEWLINE)
(KEYWORD import)
(ID "threading")
(NEWLINE)
(KEYWORD import)
(ID "weakref")
(NEWLINE)
(ID "_threads_queues")
(PUNCT "=")
(ID "weakref")
(PUNCT ".")
(ID "WeakKeyDictionary")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "_shutdown")
(PUNCT "=")
(KEYWORD False)
(NEWLINE)
(KEYWORD def)
(ID "_python_exit")
(PUNCT "(")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD global)
(ID "_shutdown")
(NEWLINE)
(ID "_shutdown")
(PUNCT "=")
(KEYWORD True)
(NEWLINE)
(ID "items")
(PUNCT "=")
(ID "list")
(PUNCT "(")
(ID "_threads_queues")
(PUNCT ".")
(ID "items")
(PUNCT "(")
(PUNCT ")")
(PUNCT ")")
(NEWLINE)
(KEYWORD for)
(ID "t")
(PUNCT ",")
(ID "q")
(KEYWORD in)
(ID "items")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "q")
(PUNCT ".")
(ID "put")
(PUNCT "(")
(KEYWORD None)
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD for)
(ID "t")
(PUNCT ",")
(ID "q")
(KEYWORD in)
(ID "items")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "t")
(PUNCT ".")
(ID "join")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(DEDENT)
(ID "atexit")
(PUNCT ".")
(ID "register")
(PUNCT "(")
(ID "_python_exit")
(PUNCT ")")
(NEWLINE)
(KEYWORD class)
(ID "_WorkItem")
(PUNCT "(")
(ID "object")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD def)
(ID "__init__")
(PUNCT "(")
(ID "self")
(PUNCT ",")
(ID "future")
(PUNCT ",")
(ID "fn")
(PUNCT ",")
(ID "args")
(PUNCT ",")
(ID "kwargs")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "self")
(PUNCT ".")
(ID "future")
(PUNCT "=")
(ID "future")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "fn")
(PUNCT "=")
(ID "fn")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "args")
(PUNCT "=")
(ID "args")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "kwargs")
(PUNCT "=")
(ID "kwargs")
(NEWLINE)
(DEDENT)
(KEYWORD def)
(ID "run")
(PUNCT "(")
(ID "self")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD if)
(KEYWORD not)
(ID "self")
(PUNCT ".")
(ID "future")
(PUNCT ".")
(ID "set_running_or_notify_cancel")
(PUNCT "(")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD return)
(NEWLINE)
(DEDENT)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "result")
(PUNCT "=")
(ID "self")
(PUNCT ".")
(ID "fn")
(PUNCT "(")
(PUNCT "*")
(ID "self")
(PUNCT ".")
(ID "args")
(PUNCT ",")
(PUNCT "**")
(ID "self")
(PUNCT ".")
(ID "kwargs")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD except)
(ID "BaseException")
(KEYWORD as)
(ID "e")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "self")
(PUNCT ".")
(ID "future")
(PUNCT ".")
(ID "set_exception")
(PUNCT "(")
(ID "e")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD else)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "self")
(PUNCT ".")
(ID "future")
(PUNCT ".")
(ID "set_result")
(PUNCT "(")
(ID "result")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(DEDENT)
(DEDENT)
(KEYWORD def)
(ID "_worker")
(PUNCT "(")
(ID "executor_reference")
(PUNCT ",")
(ID "work_queue")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD try)
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD while)
(KEYWORD True)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "work_item")
(PUNCT "=")
(ID "work_queue")
(PUNCT ".")
(ID "get")
(PUNCT "(")
(ID "block")
(PUNCT "=")
(KEYWORD True)
(PUNCT ")")
(NEWLINE)
(KEYWORD if)
(ID "work_item")
(KEYWORD is)
(KEYWORD not)
(KEYWORD None)
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "work_item")
(PUNCT ".")
(ID "run")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(KEYWORD del)
(ID "work_item")
(NEWLINE)
(KEYWORD continue)
(NEWLINE)
(DEDENT)
(ID "executor")
(PUNCT "=")
(ID "executor_reference")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(KEYWORD if)
(ID "_shutdown")
(KEYWORD or)
(ID "executor")
(KEYWORD is)
(KEYWORD None)
(KEYWORD or)
(ID "executor")
(PUNCT ".")
(ID "_shutdown")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "work_queue")
(PUNCT ".")
(ID "put")
(PUNCT "(")
(KEYWORD None)
(PUNCT ")")
(NEWLINE)
(KEYWORD return)
(NEWLINE)
(DEDENT)
(KEYWORD del)
(ID "executor")
(NEWLINE)
(DEDENT)
(DEDENT)
(KEYWORD except)
(ID "BaseException")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "_base")
(PUNCT ".")
(ID "LOGGER")
(PUNCT ".")
(ID "critical")
(PUNCT "(")
(LIT "Exception in worker")
(PUNCT ",")
(ID "exc_info")
(PUNCT "=")
(KEYWORD True)
(PUNCT ")")
(NEWLINE)
(DEDENT)
(DEDENT)
(KEYWORD class)
(ID "ThreadPoolExecutor")
(PUNCT "(")
(ID "_base")
(PUNCT ".")
(ID "Executor")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD def)
(ID "__init__")
(PUNCT "(")
(ID "self")
(PUNCT ",")
(ID "max_workers")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(LIT "Initializes a new ThreadPoolExecutor instance.\n\n        Args:\n            max_workers: The maximum number of threads that can be used to\n                execute the given calls.\n        ")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_max_workers")
(PUNCT "=")
(ID "max_workers")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_work_queue")
(PUNCT "=")
(ID "queue")
(PUNCT ".")
(ID "Queue")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_threads")
(PUNCT "=")
(ID "set")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_shutdown")
(PUNCT "=")
(KEYWORD False)
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_shutdown_lock")
(PUNCT "=")
(ID "threading")
(PUNCT ".")
(ID "Lock")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD def)
(ID "submit")
(PUNCT "(")
(ID "self")
(PUNCT ",")
(ID "fn")
(PUNCT ",")
(PUNCT "*")
(ID "args")
(PUNCT ",")
(PUNCT "**")
(ID "kwargs")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD with)
(ID "self")
(PUNCT ".")
(ID "_shutdown_lock")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD if)
(ID "self")
(PUNCT ".")
(ID "_shutdown")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD raise)
(ID "RuntimeError")
(PUNCT "(")
(LIT "cannot schedule new futures after shutdown")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(ID "f")
(PUNCT "=")
(ID "_base")
(PUNCT ".")
(ID "Future")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "w")
(PUNCT "=")
(ID "_WorkItem")
(PUNCT "(")
(ID "f")
(PUNCT ",")
(ID "fn")
(PUNCT ",")
(ID "args")
(PUNCT ",")
(ID "kwargs")
(PUNCT ")")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_work_queue")
(PUNCT ".")
(ID "put")
(PUNCT "(")
(ID "w")
(PUNCT ")")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_adjust_thread_count")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(KEYWORD return)
(ID "f")
(NEWLINE)
(DEDENT)
(DEDENT)
(ID "submit")
(PUNCT ".")
(ID "__doc__")
(PUNCT "=")
(ID "_base")
(PUNCT ".")
(ID "Executor")
(PUNCT ".")
(ID "submit")
(PUNCT ".")
(ID "__doc__")
(NEWLINE)
(KEYWORD def)
(ID "_adjust_thread_count")
(PUNCT "(")
(ID "self")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD def)
(ID "weakref_cb")
(PUNCT "(")
(ID "_")
(PUNCT ",")
(ID "q")
(PUNCT "=")
(ID "self")
(PUNCT ".")
(ID "_work_queue")
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "q")
(PUNCT ".")
(ID "put")
(PUNCT "(")
(KEYWORD None)
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD if)
(ID "len")
(PUNCT "(")
(ID "self")
(PUNCT ".")
(ID "_threads")
(PUNCT ")")
(PUNCT "<")
(ID "self")
(PUNCT ".")
(ID "_max_workers")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "t")
(PUNCT "=")
(ID "threading")
(PUNCT ".")
(ID "Thread")
(PUNCT "(")
(ID "target")
(PUNCT "=")
(ID "_worker")
(PUNCT ",")
(ID "args")
(PUNCT "=")
(PUNCT "(")
(ID "weakref")
(PUNCT ".")
(ID "ref")
(PUNCT "(")
(ID "self")
(PUNCT ",")
(ID "weakref_cb")
(PUNCT ")")
(PUNCT ",")
(ID "self")
(PUNCT ".")
(ID "_work_queue")
(PUNCT ")")
(PUNCT ")")
(NEWLINE)
(ID "t")
(PUNCT ".")
(ID "daemon")
(PUNCT "=")
(KEYWORD True)
(NEWLINE)
(ID "t")
(PUNCT ".")
(ID "start")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_threads")
(PUNCT ".")
(ID "add")
(PUNCT "(")
(ID "t")
(PUNCT ")")
(NEWLINE)
(ID "_threads_queues")
(PUNCT "[")
(ID "t")
(PUNCT "]")
(PUNCT "=")
(ID "self")
(PUNCT ".")
(ID "_work_queue")
(NEWLINE)
(DEDENT)
(DEDENT)
(KEYWORD def)
(ID "shutdown")
(PUNCT "(")
(ID "self")
(PUNCT ",")
(ID "wait")
(PUNCT "=")
(KEYWORD True)
(PUNCT ")")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD with)
(ID "self")
(PUNCT ".")
(ID "_shutdown_lock")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "self")
(PUNCT ".")
(ID "_shutdown")
(PUNCT "=")
(KEYWORD True)
(NEWLINE)
(ID "self")
(PUNCT ".")
(ID "_work_queue")
(PUNCT ".")
(ID "put")
(PUNCT "(")
(KEYWORD None)
(PUNCT ")")
(NEWLINE)
(DEDENT)
(KEYWORD if)
(ID "wait")
(PUNCT ":")
(NEWLINE)
(INDENT)
(KEYWORD for)
(ID "t")
(KEYWORD in)
(ID "self")
(PUNCT ".")
(ID "_threads")
(PUNCT ":")
(NEWLINE)
(INDENT)
(ID "t")
(PUNCT ".")
(ID "join")
(PUNCT "(")
(PUNCT ")")
(NEWLINE)
(DEDENT)
(DEDENT)
(DEDENT)
(ID "shutdown")
(PUNCT ".")
(ID "__doc__")
(PUNCT "=")
(ID "_base")
(PUNCT ".")
(ID "Executor")
(PUNCT ".")
(ID "shutdown")
(PUNCT ".")
(ID "__doc__")
(NEWLINE)
(DEDENT)
(ENDMARKER)
